; ==============================================================================
; КОНФИГУРАЦИЯ ПУЛА PHP-FPM (www)
; Особенности:
;   - Работа через UNIX-сокет для максимальной производительности
;   - Оптимизировано для Docker и Alpine Linux
; ==============================================================================

; Название пула процессов (используется в логах/статусе и при наличии нескольких пулов)
[www]

; Адрес прослушивания.
; UNIX-сокет быстрее TCP внутри одного хоста/контейнерной сети (нет накладных расходов на сеть).
listen = /var/run/php/php-fpm.sock

; Пользователь и группа, от имени которых будут выполняться PHP-скрипты.
; Важно: должны совпадать с моделью прав на файлы проекта (storage/, cache/ и т.п.)
user = www-data
group = www-data

; Права доступа к сокету:
; - владелец/группа сокета выставляются при старте php-fpm
; - Nginx должен иметь доступ к сокету (обычно через ту же группу или пользователя)
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

; Прокидывать переменные окружения внутрь PHP.
; clear_env = no — НЕ очищать окружение, т.е. env-переменные контейнера будут видны в PHP (getenv(), $_ENV).
; Удобно для Docker (DB_*, REDIS_*, XDEBUG_* и т.п.).
; В проде иногда включают clear_env = yes и явно перечисляют env[VAR] = ... для более строгой модели.
clear_env = no

; ------------------------------------------------------------------------------
; Управление процессами (Process Manager)
; ------------------------------------------------------------------------------

; Режим управления процессами:
; dynamic — php-fpm сам поддерживает нужное число воркеров между min/max spare.
; Подходит для большинства приложений и умеренной нагрузки.
pm = dynamic

; Верхний предел воркеров (процессов), обслуживающих запросы одновременно.
; Главный лимит по памяти/конкурентности: каждый воркер потребляет RAM.
pm.max_children = 10

; Количество воркеров, создаваемых при старте пула.
; Слишком высокое значение может зря расходовать память, слишком низкое — добавит задержку на «прогрев».
pm.start_servers = 2

; Минимальное количество «ожидающих» (idle) воркеров.
; Если idle меньше этого значения — php-fpm будет форкать новые процессы.
pm.min_spare_servers = 1

; Максимальное количество «ожидающих» (idle) воркеров.
; Если idle больше — php-fpm будет завершать лишние воркеры, освобождая память.
pm.max_spare_servers = 3

; Ограничение числа запросов на один воркер до перезапуска.
; Полезно против утечек памяти/фрагментации: воркер «освежается» после N запросов.
pm.max_requests = 500

; ------------------------------------------------------------------------------
; Логи и диагностика
; ------------------------------------------------------------------------------

; Перехватывать stdout/stderr воркеров и отправлять в лог php-fpm.
; В Docker это удобно: сообщения попадают в логи контейнера и видны через `docker logs`.
catch_workers_output = yes

; Таймаут для «медленных» запросов.
; Если запрос выполняется дольше указанного — будет записан slowlog с backtrace (где именно тормозит).
request_slowlog_timeout = 5s

; Куда писать slowlog.
; /proc/self/fd/2 = stderr текущего процесса (идеально для контейнеров: попадёт в агрегированные логи).
slowlog = /proc/self/fd/2

; Жёсткий таймаут выполнения запроса (kill воркера, если запрос не завершился).
; Это «последний рубеж», чтобы зависшие запросы не удерживали воркеры бесконечно.
request_terminate_timeout = 60s

; ------------------------------------------------------------------------------
; Healthcheck
; ------------------------------------------------------------------------------

; Встроенный ping endpoint FPM (для healthcheck).
; Обычно дергается внутренними проверками (как у тебя через cgi-fcgi) и НЕ должен быть доступен из интернета.
ping.path = /ping

; Тело ответа для ping (что именно вернётся при успешном ответе).
ping.response = pong

; ------------------------------------------------------------------------------
; Безопасность
; ------------------------------------------------------------------------------

; Ограничение расширений файлов, которые FPM согласен исполнять.
; Защищает от случайной обработки «не-PHP» файлов через fastcgi.
security.limit_extensions = .php
